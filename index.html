<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Workspace Switcher</title>
  <style>
    :root{
      --bg:#0b0c10;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.65);
      --shadow: 0 24px 80px rgba(0,0,0,.55);
      --blur: 16px;
      --r: 18px;
      --r2: 14px;
      --pad: 14px;
      --accent: #7dd3fc;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1100px 700px at 20% 10%, rgba(125,211,252,.12), transparent 55%),
        radial-gradient(900px 600px at 80% 30%, rgba(167,139,250,.10), transparent 55%),
        radial-gradient(900px 700px at 50% 95%, rgba(34,197,94,.08), transparent 55%),
        var(--bg);
      color:var(--text);
      overflow:hidden;
    }

    .app{
      height:100%;
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:14px;
    }

    .topbar{
      display:flex;
      gap:12px;
      align-items:center;
      padding:12px;
      border-radius: var(--r);
      background: var(--panel);
      border:1px solid var(--stroke);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 210px;
    }
    .dot{
      width:14px; height:14px; border-radius: 999px;
      background: linear-gradient(135deg, rgba(125,211,252,.95), rgba(167,139,250,.9));
      box-shadow: 0 0 0 6px rgba(125,211,252,.10);
    }
    .brand h1{font-size:14px; margin:0; letter-spacing:.2px}
    .brand .sub{font-size:12px; color:var(--muted); margin-top:2px}

    .search{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
    }
    .search input{
      width:100%;
      background:transparent;
      border:0;
      outline:none;
      color:var(--text);
      font-size:14px;
    }
    .search .hint{font-size:12px; color:var(--muted); white-space:nowrap}

    .btns{display:flex; gap:10px; align-items:center}
    button{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius: 999px;
      font-size:13px;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      backdrop-filter: blur(var(--blur));
    }
    button:hover{background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.18)}
    button:active{transform: translateY(1px)}
    .primary{
      border-color: rgba(125,211,252,.35);
      background: rgba(125,211,252,.12);
    }
    .danger{
      border-color: rgba(244,63,94,.35);
      background: rgba(244,63,94,.10);
    }
    .ghost{
      background: transparent;
    }

    .content{
      flex:1;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:12px;
      min-height:0;
    }

    .panel{
      background: var(--panel);
      border:1px solid var(--stroke);
      border-radius: var(--r);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      min-height:0;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .panelHeader{
      padding:12px 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .panelHeader h2{margin:0; font-size:12px; letter-spacing:.35px; text-transform:uppercase; color:var(--muted)}
    .panelHeader .mini{
      display:flex; gap:8px; align-items:center;
      color:var(--muted);
      font-size:12px;
    }

    .scroll{
      overflow:auto;
      padding:10px;
      min-height:0;
    }
    .scroll::-webkit-scrollbar{width:10px}
    .scroll::-webkit-scrollbar-thumb{background: rgba(255,255,255,.10); border-radius: 999px}
    .scroll::-webkit-scrollbar-track{background: transparent}

    /* Folder list */
    .folder{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border-radius: var(--r2);
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      margin-bottom:10px;
      user-select:none;
    }
    .folder[data-active="true"]{
      background: rgba(125,211,252,.10);
      border-color: rgba(125,211,252,.28);
    }
    .folderLeft{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .emoji{
      width:34px; height:34px;
      border-radius: 12px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      flex: 0 0 auto;
      font-size:16px;
    }
    .folderText{min-width:0}
    .folderName{
      font-size:13px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      margin:0;
    }
    .folderMeta{
      font-size:12px; color:var(--muted); margin-top:2px;
    }
    .folderActions{
      display:flex; gap:8px; align-items:center; flex:0 0 auto;
    }
    .iconBtn{
      padding:8px 9px;
      border-radius: 999px;
      font-size:12px;
    }

    .dragHint{
      font-size:11px;
      color:var(--muted);
      padding:10px 10px 0;
    }

    /* Items */
    .toolbar{
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      flex-wrap:wrap;
    }
    .pill{
      display:flex; align-items:center; gap:8px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      padding:8px 10px;
      border-radius: 999px;
      font-size:12px;
      color:var(--muted);
    }
    .pill strong{color:var(--text); font-weight:600}

    .grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width: 1100px){ .grid{grid-template-columns: repeat(2, minmax(0, 1fr));} }
    @media (max-width: 860px){
      body{overflow:auto}
      .app{overflow:auto}
      .content{grid-template-columns: 1fr; }
      .brand{min-width:auto}
      .grid{grid-template-columns: 1fr;}
    }

    .card{
      border-radius: var(--r);
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:120px;
      position:relative;
      user-select:none;
    }
    .card[data-drag="true"]{
      outline: 2px solid rgba(125,211,252,.55);
      outline-offset: 2px;
    }
    .cardTop{
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
    }
    .title{
      margin:0;
      font-size:13px;
      line-height:1.25;
      word-break:break-word;
    }
    .url{
      color:var(--muted);
      font-size:12px;
      word-break:break-all;
      margin:0;
    }
    .tag{
      font-size:11px;
      color:rgba(255,255,255,.75);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:6px 8px;
      border-radius: 999px;
      align-self:flex-start;
    }
    .cardActions{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top:auto;
    }
    .cardActions button{padding:8px 10px; font-size:12px}

    .empty{
      padding:18px 12px;
      color:var(--muted);
      font-size:13px;
      line-height:1.45;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:11px;
      padding:2px 6px;
      border-radius: 6px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:rgba(255,255,255,.85);
    }

    /* Modal */
    .modalBg{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:50;
    }
    .modalBg[data-open="true"]{display:flex}
    .modal{
      width:min(720px, 100%);
      border-radius: 22px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(18px);
      box-shadow: 0 30px 120px rgba(0,0,0,.7);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.12);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .modalHead h3{margin:0; font-size:14px}
    .modalBody{padding:14px}
    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .form .full{grid-column: 1 / -1}
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px;
    }
    input, textarea, select{
      width:100%;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding:10px 11px;
      outline:none;
      font-size:13px;
    }
    textarea{min-height:92px; resize:vertical}
    .modalFoot{
      padding:12px 14px 14px;
      border-top:1px solid rgba(255,255,255,.12);
      display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;
    }
    .hr{
      height:1px; background: rgba(255,255,255,.10); margin:12px 0;
    }
    .tiny{
      font-size:12px; color:var(--muted); line-height:1.4;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <h1>Workspace Switcher</h1>
          <div class="sub">localStorage tab/link dashboard</div>
        </div>
      </div>

      <div class="search" title="Search links in the current workspace">
        <span style="color:var(--muted);font-size:12px;">‚åï</span>
        <input id="searchInput" type="text" placeholder="Search links‚Ä¶" />
        <span class="hint"><span class="kbd">/</span> focus</span>
      </div>

      <div class="btns">
        <button id="btnNewFolder" class="primary">New folder</button>
        <button id="btnNewLink">New link</button>
        <button id="btnIO" class="ghost">Import/Export</button>
        <button id="btnSettings" class="ghost">Settings</button>
      </div>
    </div>

    <div class="content">
      <!-- Left: folders -->
      <div class="panel">
        <div class="panelHeader">
          <h2>Folders</h2>
          <div class="mini"><span id="folderCount">0</span></div>
        </div>
        <div class="dragHint">Drag folders to reorder.</div>
        <div id="folderList" class="scroll"></div>
      </div>

      <!-- Right: items -->
      <div class="panel">
        <div class="toolbar">
          <div class="pill">
            Active: <strong id="activeFolderName">‚Äî</strong>
          </div>
          <div class="pill">
            Links: <strong id="activeFolderLinks">0</strong>
          </div>
          <div style="flex:1"></div>
          <button id="btnOpenAll" class="primary" title="Open all links in this folder">Open all</button>
          <button id="btnFolderEdit" title="Edit folder">Edit folder</button>
          <button id="btnFolderDelete" class="danger" title="Delete folder">Delete</button>
        </div>
        <div id="itemsWrap" class="scroll">
          <div id="itemsGrid" class="grid"></div>
          <div id="emptyState" class="empty" style="display:none;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modalBg" class="modalBg" data-open="false" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <div class="modalHead">
        <h3 id="modalTitle">Modal</h3>
        <button id="modalClose" class="ghost">Close</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalFoot" id="modalFoot"></div>
    </div>
  </div>

  <script>
    /***********************
     * Workspace Switcher
     * -------------------
     * Single-file, localStorage, drag reorder, open-all.
     ***********************/

    const LS_KEY = "workspace_switcher_v1";
    const now = () => Date.now();

    /** Settings */
    const defaultSettings = {
      openMode: "tabs",          // "tabs" | "window"
      confirmOpenAll: true,
      maxOpenAll: 24,            // safety cap
      openDelayMs: 80            // throttle tab openings
    };

    /** Default data */
    function seedData(){
      const id = () => crypto.randomUUID ? crypto.randomUUID() : (Math.random().toString(16).slice(2) + "-" + now());
      const work = id(), life = id(), learn = id();

      return {
        version: 1,
        settings: { ...defaultSettings },
        activeFolderId: work,
        folders: [
          {
            id: work,
            name: "Work",
            emoji: "üß†",
            createdAt: now(),
            order: 0,
            links: [
              { id: id(), title: "Email", url: "https://mail.google.com/", createdAt: now(), order: 0 },
              { id: id(), title: "Calendar", url: "https://calendar.google.com/", createdAt: now(), order: 1 },
              { id: id(), title: "GitHub", url: "https://github.com/", createdAt: now(), order: 2 }
            ]
          },
          {
            id: life,
            name: "Life",
            emoji: "‚ú®",
            createdAt: now(),
            order: 1,
            links: [
              { id: id(), title: "YouTube", url: "https://www.youtube.com/", createdAt: now(), order: 0 },
              { id: id(), title: "Spotify", url: "https://open.spotify.com/", createdAt: now(), order: 1 }
            ]
          },
          {
            id: learn,
            name: "Learn",
            emoji: "üìö",
            createdAt: now(),
            order: 2,
            links: [
              { id: id(), title: "MDN", url: "https://developer.mozilla.org/", createdAt: now(), order: 0 },
              { id: id(), title: "Stack Overflow", url: "https://stackoverflow.com/", createdAt: now(), order: 1 }
            ]
          }
        ]
      };
    }

    function load(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return seedData();
        const data = JSON.parse(raw);
        // basic migration/sanity
        data.settings = { ...defaultSettings, ...(data.settings || {}) };
        data.folders = Array.isArray(data.folders) ? data.folders : [];
        if(!data.activeFolderId && data.folders[0]) data.activeFolderId = data.folders[0].id;
        return data;
      }catch{
        return seedData();
      }
    }

    function save(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }

    let state = load();

    /***************
     * DOM refs
     ***************/
    const el = {
      folderList: document.getElementById("folderList"),
      folderCount: document.getElementById("folderCount"),
      activeFolderName: document.getElementById("activeFolderName"),
      activeFolderLinks: document.getElementById("activeFolderLinks"),
      itemsGrid: document.getElementById("itemsGrid"),
      emptyState: document.getElementById("emptyState"),
      searchInput: document.getElementById("searchInput"),
      btnNewFolder: document.getElementById("btnNewFolder"),
      btnNewLink: document.getElementById("btnNewLink"),
      btnIO: document.getElementById("btnIO"),
      btnSettings: document.getElementById("btnSettings"),
      btnOpenAll: document.getElementById("btnOpenAll"),
      btnFolderEdit: document.getElementById("btnFolderEdit"),
      btnFolderDelete: document.getElementById("btnFolderDelete"),

      modalBg: document.getElementById("modalBg"),
      modalTitle: document.getElementById("modalTitle"),
      modalBody: document.getElementById("modalBody"),
      modalFoot: document.getElementById("modalFoot"),
      modalClose: document.getElementById("modalClose"),
    };

    /***************
     * Utilities
     ***************/
    function id(){
      return crypto.randomUUID ? crypto.randomUUID() : (Math.random().toString(16).slice(2) + "-" + now());
    }
    function byOrder(a,b){ return (a.order ?? 0) - (b.order ?? 0); }
    function activeFolder(){
      return state.folders.find(f => f.id === state.activeFolderId) || state.folders.sort(byOrder)[0] || null;
    }
    function setActiveFolder(folderId){
      state.activeFolderId = folderId;
      save();
      render();
    }
    function normalizeOrders(){
      state.folders.sort(byOrder).forEach((f,i)=> f.order=i);
      state.folders.forEach(f=>{
        f.links = (f.links || []).sort(byOrder);
        f.links.forEach((l,i)=> l.order=i);
      });
    }
    function safeUrl(url){
      try{
        const u = new URL(url);
        return u.toString();
      }catch{
        // allow missing protocol -> add https
        try{
          const u = new URL("https://" + url);
          return u.toString();
        }catch{
          return null;
        }
      }
    }
    function domainOf(url){
      try{ return new URL(url).hostname.replace(/^www\./,""); }catch{ return ""; }
    }

    /***************
     * Modal system
     ***************/
    function openModal({title, body, footer}){
      el.modalTitle.textContent = title;
      el.modalBody.innerHTML = "";
      el.modalFoot.innerHTML = "";
      el.modalBody.appendChild(body);
      footer.forEach(btn => el.modalFoot.appendChild(btn));
      el.modalBg.dataset.open = "true";
    }
    function closeModal(){
      el.modalBg.dataset.open = "false";
      el.modalBody.innerHTML = "";
      el.modalFoot.innerHTML = "";
    }
    el.modalClose.addEventListener("click", closeModal);
    el.modalBg.addEventListener("click", (e)=>{ if(e.target === el.modalBg) closeModal(); });
    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape" && el.modalBg.dataset.open === "true") closeModal();
      if(e.key === "/" && document.activeElement !== el.searchInput){
        e.preventDefault();
        el.searchInput.focus();
      }
    });

    function mkButton(label, {cls="", onClick}){
      const b = document.createElement("button");
      b.textContent = label;
      b.className = cls;
      b.addEventListener("click", onClick);
      return b;
    }

    /***************
     * Folder CRUD
     ***************/
    function showFolderModal(folder){
      const isEdit = !!folder;
      const f = folder ? {...folder} : { id: id(), name:"", emoji:"üìÅ" };

      const wrap = document.createElement("div");
      wrap.innerHTML = `
        <div class="form">
          <div>
            <label>Folder name</label>
            <input id="f_name" placeholder="e.g., Work, School, Morning, Clients" value="${escapeHtml(f.name || "")}">
          </div>
          <div>
            <label>Emoji</label>
            <input id="f_emoji" placeholder="e.g., üß†" value="${escapeHtml(f.emoji || "üìÅ")}">
          </div>
          <div class="full tiny">
            Tip: keep folders simple. The value is in ‚ÄúOpen all‚Äù + fast access.
          </div>
        </div>
      `;

      const btnCancel = mkButton("Cancel", {cls:"ghost", onClick: closeModal});
      const btnSave = mkButton(isEdit ? "Save changes" : "Create folder", {
        cls:"primary",
        onClick: ()=>{
          const name = wrap.querySelector("#f_name").value.trim();
          const emoji = (wrap.querySelector("#f_emoji").value.trim() || "üìÅ").slice(0,4);
          if(!name){ alert("Folder name is required."); return; }

          if(isEdit){
            const target = state.folders.find(x=>x.id===folder.id);
            if(!target) return;
            target.name = name;
            target.emoji = emoji;
          }else{
            const maxOrder = Math.max(-1, ...state.folders.map(x=>x.order ?? 0));
            state.folders.push({
              id: f.id,
              name,
              emoji,
              createdAt: now(),
              order: maxOrder + 1,
              links: []
            });
            state.activeFolderId = f.id;
          }
          save();
          render();
          closeModal();
        }
      });

      openModal({ title: isEdit ? "Edit folder" : "New folder", body: wrap, footer: [btnCancel, btnSave] });
      setTimeout(()=>wrap.querySelector("#f_name").focus(), 30);
    }

    function deleteFolder(folderId){
      const f = state.folders.find(x=>x.id===folderId);
      if(!f) return;

      const wrap = document.createElement("div");
      wrap.innerHTML = `
        <div class="tiny">
          Delete <b>${escapeHtml(f.name)}</b> and its <b>${(f.links||[]).length}</b> link(s)?
          <div class="hr"></div>
          This cannot be undone (unless you export first).
        </div>
      `;
      const btnCancel = mkButton("Cancel", {cls:"ghost", onClick: closeModal});
      const btnDel = mkButton("Delete", {
        cls:"danger",
        onClick: ()=>{
          state.folders = state.folders.filter(x=>x.id!==folderId);
          normalizeOrders();
          const next = state.folders.sort(byOrder)[0];
          state.activeFolderId = next ? next.id : null;
          save();
          render();
          closeModal();
        }
      });
      openModal({ title: "Delete folder", body: wrap, footer: [btnCancel, btnDel] });
    }

    /***************
     * Link CRUD
     ***************/
    function showLinkModal(link){
      const folder = activeFolder();
      if(!folder){
        alert("Create a folder first.");
        return;
      }
      const isEdit = !!link;
      const l = link ? {...link} : { id: id(), title:"", url:"" };

      const wrap = document.createElement("div");
      wrap.innerHTML = `
        <div class="form">
          <div class="full">
            <label>Title</label>
            <input id="l_title" placeholder="e.g., Gmail, Jira, Canvas, Bank" value="${escapeHtml(l.title || "")}">
          </div>
          <div class="full">
            <label>URL</label>
            <input id="l_url" placeholder="https://‚Ä¶" value="${escapeHtml(l.url || "")}">
          </div>
          <div class="full tiny">
            Tip: you can paste ‚Äúgoogle.com‚Äù and it will auto-fix to https://google.com
          </div>
        </div>
      `;

      const btnCancel = mkButton("Cancel", {cls:"ghost", onClick: closeModal});
      const btnSave = mkButton(isEdit ? "Save changes" : "Add link", {
        cls:"primary",
        onClick: ()=>{
          const title = wrap.querySelector("#l_title").value.trim();
          const urlRaw = wrap.querySelector("#l_url").value.trim();
          const url = safeUrl(urlRaw);
          if(!title){ alert("Title is required."); return; }
          if(!url){ alert("Enter a valid URL."); return; }

          if(isEdit){
            const target = folder.links.find(x=>x.id===link.id);
            if(!target) return;
            target.title = title;
            target.url = url;
          }else{
            const maxOrder = Math.max(-1, ...(folder.links||[]).map(x=>x.order ?? 0));
            folder.links.push({
              id: l.id,
              title,
              url,
              createdAt: now(),
              order: maxOrder + 1
            });
          }
          save();
          render();
          closeModal();
        }
      });

      openModal({ title: isEdit ? "Edit link" : `New link ‚Üí ${folder.name}`, body: wrap, footer: [btnCancel, btnSave] });
      setTimeout(()=>wrap.querySelector("#l_title").focus(), 30);
    }

    function deleteLink(linkId){
      const folder = activeFolder();
      if(!folder) return;
      folder.links = (folder.links||[]).filter(x=>x.id!==linkId);
      normalizeOrders();
      save();
      render();
    }

    /***************
     * Open behavior
     ***************/
    async function openAllInFolder(){
      const folder = activeFolder();
      if(!folder) return;

      const links = (folder.links||[]).sort(byOrder);
      if(!links.length){ alert("No links in this folder."); return; }

      const settings = state.settings || defaultSettings;
      const cap = Math.max(1, settings.maxOpenAll || 24);
      const toOpen = links.slice(0, cap);

      if(settings.confirmOpenAll){
        const ok = confirm(`Open ${toOpen.length}${links.length>cap ? " (capped)" : ""} tabs from "${folder.name}"?`);
        if(!ok) return;
      }

      if(settings.openMode === "window"){
        // Build a window with the first URL; then open the rest into that window when possible.
        const first = toOpen[0];
        const w = window.open(first.url, "_blank");
        if(!w){
          alert("Popup blocked. Allow popups to open in a new window, or switch to tabs mode in Settings.");
          return;
        }
        for(let i=1;i<toOpen.length;i++){
          await sleep(settings.openDelayMs || 80);
          try{ w.open(toOpen[i].url, "_blank"); }catch{ window.open(toOpen[i].url, "_blank"); }
        }
        return;
      }

      // tabs mode
      let opened = 0;
      for(const item of toOpen){
        const w = window.open(item.url, "_blank");
        if(!w && opened===0){
          alert("Popup blocked. Allow popups or reduce confirm/open settings.");
          return;
        }
        opened++;
        await sleep(settings.openDelayMs || 80);
      }
    }

    function openOne(url){
      window.open(url, "_blank");
    }

    function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

    /***************
     * Import / Export
     ***************/
    function showImportExport(){
      const wrap = document.createElement("div");
      const data = JSON.stringify(state, null, 2);

      wrap.innerHTML = `
        <div class="tiny">
          Export your setup (move machines, share with friends, backups). Import replaces your current data.
        </div>
        <div class="hr"></div>
        <label>Export (copy this)</label>
        <textarea id="io_area">${escapeHtml(data)}</textarea>
        <div class="hr"></div>
        <div class="tiny">
          Import: paste JSON above, then click ‚ÄúImport‚Äù.
        </div>
      `;

      const btnClose = mkButton("Close", {cls:"ghost", onClick: closeModal});
      const btnCopy = mkButton("Copy export", {
        cls:"",
        onClick: async ()=>{
          const area = wrap.querySelector("#io_area");
          area.select();
          try{ await navigator.clipboard.writeText(area.value); }catch{ document.execCommand("copy"); }
        }
      });
      const btnImport = mkButton("Import (replace)", {
        cls:"primary",
        onClick: ()=>{
          const txt = wrap.querySelector("#io_area").value.trim();
          try{
            const obj = JSON.parse(txt);
            // minimal validation
            if(!obj || !Array.isArray(obj.folders)) throw new Error("Invalid format");
            obj.settings = { ...defaultSettings, ...(obj.settings || {}) };
            state = obj;
            normalizeOrders();
            save();
            render();
            closeModal();
          }catch{
            alert("Import failed. Paste valid JSON from an export.");
          }
        }
      });

      openModal({ title:"Import / Export", body: wrap, footer: [btnClose, btnCopy, btnImport] });
      setTimeout(()=>wrap.querySelector("#io_area").focus(), 30);
    }

    /***************
     * Settings
     ***************/
    function showSettings(){
      const s = { ...defaultSettings, ...(state.settings || {}) };

      const wrap = document.createElement("div");
      wrap.innerHTML = `
        <div class="form">
          <div>
            <label>Open mode</label>
            <select id="s_mode">
              <option value="tabs">New tabs</option>
              <option value="window">New window</option>
            </select>
          </div>
          <div>
            <label>Confirm ‚ÄúOpen all‚Äù</label>
            <select id="s_confirm">
              <option value="true">On</option>
              <option value="false">Off</option>
            </select>
          </div>
          <div>
            <label>Safety cap (max tabs)</label>
            <input id="s_cap" type="number" min="1" max="100" value="${s.maxOpenAll}">
          </div>
          <div>
            <label>Open delay (ms)</label>
            <input id="s_delay" type="number" min="0" max="2000" value="${s.openDelayMs}">
          </div>
          <div class="full tiny">
            Note: browsers may block popups if you try to open many links too fast or without a click.
          </div>
        </div>
      `;

      wrap.querySelector("#s_mode").value = s.openMode;
      wrap.querySelector("#s_confirm").value = String(!!s.confirmOpenAll);

      const btnClose = mkButton("Close", {cls:"ghost", onClick: closeModal});
      const btnSave = mkButton("Save settings", {
        cls:"primary",
        onClick: ()=>{
          const openMode = wrap.querySelector("#s_mode").value;
          const confirmOpenAll = wrap.querySelector("#s_confirm").value === "true";
          const maxOpenAll = clampInt(wrap.querySelector("#s_cap").value, 1, 100, defaultSettings.maxOpenAll);
          const openDelayMs = clampInt(wrap.querySelector("#s_delay").value, 0, 2000, defaultSettings.openDelayMs);

          state.settings = { openMode, confirmOpenAll, maxOpenAll, openDelayMs };
          save();
          closeModal();
        }
      });

      openModal({ title:"Settings", body: wrap, footer: [btnClose, btnSave] });
    }

    function clampInt(val, min, max, fallback){
      const n = parseInt(val, 10);
      if(Number.isNaN(n)) return fallback;
      return Math.min(max, Math.max(min, n));
    }

    /***************
     * Drag & Drop reorder
     ***************/
    let drag = { type:null, folderId:null, linkId:null };

    function onFolderDragStart(e, folderId){
      drag = { type:"folder", folderId, linkId:null };
      e.dataTransfer.effectAllowed = "move";
      e.dataTransfer.setData("text/plain", folderId);
    }
    function onFolderDrop(e, targetFolderId){
      e.preventDefault();
      if(drag.type !== "folder" || drag.folderId === targetFolderId) return;

      const list = state.folders.sort(byOrder);
      const from = list.findIndex(f=>f.id===drag.folderId);
      const to = list.findIndex(f=>f.id===targetFolderId);
      if(from<0 || to<0) return;

      const [moved] = list.splice(from, 1);
      list.splice(to, 0, moved);
      list.forEach((f,i)=> f.order=i);
      save();
      render();
    }

    function onLinkDragStart(e, linkId){
      const folder = activeFolder();
      if(!folder) return;
      drag = { type:"link", folderId: folder.id, linkId };
      e.dataTransfer.effectAllowed = "move";
      e.dataTransfer.setData("text/plain", linkId);
    }
    function onLinkDrop(e, targetLinkId){
      e.preventDefault();
      if(drag.type !== "link" || drag.linkId === targetLinkId) return;

      const folder = activeFolder();
      if(!folder || folder.id !== drag.folderId) return;

      const list = (folder.links||[]).sort(byOrder);
      const from = list.findIndex(l=>l.id===drag.linkId);
      const to = list.findIndex(l=>l.id===targetLinkId);
      if(from<0 || to<0) return;

      const [moved] = list.splice(from, 1);
      list.splice(to, 0, moved);
      list.forEach((l,i)=> l.order=i);
      folder.links = list;

      save();
      render();
    }

    /***************
     * Render
     ***************/
    function render(){
      normalizeOrders();

      // folders
      const folders = state.folders.sort(byOrder);
      el.folderCount.textContent = String(folders.length);
      el.folderList.innerHTML = "";

      folders.forEach(f=>{
        const node = document.createElement("div");
        node.className = "folder";
        node.draggable = true;
        node.dataset.active = String(f.id === state.activeFolderId);
        node.addEventListener("click", ()=> setActiveFolder(f.id));
        node.addEventListener("dragstart", (e)=> onFolderDragStart(e, f.id));
        node.addEventListener("dragover", (e)=> e.preventDefault());
        node.addEventListener("drop", (e)=> onFolderDrop(e, f.id));

        const left = document.createElement("div");
        left.className = "folderLeft";
        left.innerHTML = `
          <div class="emoji">${escapeHtml(f.emoji || "üìÅ")}</div>
          <div class="folderText">
            <p class="folderName">${escapeHtml(f.name || "Untitled")}</p>
            <div class="folderMeta">${(f.links||[]).length} link(s)</div>
          </div>
        `;

        const actions = document.createElement("div");
        actions.className = "folderActions";

        const openBtn = document.createElement("button");
        openBtn.className = "iconBtn primary";
        openBtn.textContent = "Open";
        openBtn.title = "Open all links";
        openBtn.addEventListener("click", (e)=>{ e.stopPropagation(); setActiveFolder(f.id); openAllInFolder(); });

        const editBtn = document.createElement("button");
        editBtn.className = "iconBtn";
        editBtn.textContent = "Edit";
        editBtn.addEventListener("click", (e)=>{ e.stopPropagation(); showFolderModal(f); });

        actions.appendChild(openBtn);
        actions.appendChild(editBtn);

        node.appendChild(left);
        node.appendChild(actions);
        el.folderList.appendChild(node);
      });

      // active
      const f = activeFolder();
      const activeName = f ? f.name : "‚Äî";
      el.activeFolderName.textContent = activeName;
      el.activeFolderLinks.textContent = String(f ? (f.links||[]).length : 0);

      el.btnOpenAll.disabled = !f || !(f.links||[]).length;
      el.btnFolderEdit.disabled = !f;
      el.btnFolderDelete.disabled = !f;

      // items
      el.itemsGrid.innerHTML = "";
      const q = (el.searchInput.value || "").trim().toLowerCase();

      if(!f){
        el.emptyState.style.display = "block";
        el.emptyState.innerHTML = `No folders yet. Click <b>New folder</b> to start.`;
        return;
      }

      const links = (f.links||[]).sort(byOrder);
      const filtered = links.filter(l=>{
        if(!q) return true;
        const hay = (l.title + " " + l.url + " " + domainOf(l.url)).toLowerCase();
        return hay.includes(q);
      });

      if(!filtered.length){
        el.emptyState.style.display = "block";
        el.emptyState.innerHTML = q
          ? `No results for <span class="kbd">${escapeHtml(q)}</span> in <b>${escapeHtml(f.name)}</b>.`
          : `No links in <b>${escapeHtml(f.name)}</b> yet.<br><br>
             Click <b>New link</b> or press <span class="kbd">/</span> to search.`;
      }else{
        el.emptyState.style.display = "none";
      }

      filtered.forEach(l=>{
        const card = document.createElement("div");
        card.className = "card";
        card.draggable = true;

        card.addEventListener("dragstart", (e)=> onLinkDragStart(e, l.id));
        card.addEventListener("dragover", (e)=> e.preventDefault());
        card.addEventListener("drop", (e)=> onLinkDrop(e, l.id));

        const tag = domainOf(l.url) || "link";

        card.innerHTML = `
          <div class="cardTop">
            <div style="min-width:0">
              <p class="title">${escapeHtml(l.title)}</p>
              <p class="url">${escapeHtml(l.url)}</p>
            </div>
          </div>
          <div class="tag">${escapeHtml(tag)}</div>
          <div class="cardActions">
            <button class="primary" data-act="open">Open</button>
            <button data-act="edit">Edit</button>
            <button class="danger" data-act="del">Delete</button>
          </div>
        `;

        card.querySelector('[data-act="open"]').addEventListener("click", ()=> openOne(l.url));
        card.querySelector('[data-act="edit"]').addEventListener("click", ()=> showLinkModal(l));
        card.querySelector('[data-act="del"]').addEventListener("click", ()=> deleteLink(l.id));

        el.itemsGrid.appendChild(card);
      });
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /***************
     * Events
     ***************/
    el.btnNewFolder.addEventListener("click", ()=> showFolderModal(null));
    el.btnNewLink.addEventListener("click", ()=> showLinkModal(null));
    el.btnIO.addEventListener("click", showImportExport);
    el.btnSettings.addEventListener("click", showSettings);

    el.btnOpenAll.addEventListener("click", openAllInFolder);
    el.btnFolderEdit.addEventListener("click", ()=> {
      const f = activeFolder(); if(!f) return;
      showFolderModal(f);
    });
    el.btnFolderDelete.addEventListener("click", ()=> {
      const f = activeFolder(); if(!f) return;
      deleteFolder(f.id);
    });

    el.searchInput.addEventListener("input", render);

    /***************
     * First paint
     ***************/
    render();
  </script>
</body>
</html>
